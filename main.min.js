var camera,scene,renderer,triangle,plane,xSpeed,zOffset,camOffset,stars,starSpeed,leftArrow,rightArrow,timeElapse,cubeAdd,score,phase,composer,level,levelBreak,width,height,mCubes,numCubes=100,rotStart=0,stnDiff=0,stnBounce=0,stnCam=0,stnBlock=0,uiNewGame=document.getElementById("newGame"),uiScore=document.getElementById("score"),uiHScore=document.getElementById("highScore"),uiInfo=document.getElementById("info"),uiSettings=document.getElementById("settings"),uiPause=document.getElementById("pause");function init(){width=window.innerWidth,height=window.innerHeight,levelBreak=0,level=0,phase=-1,score=0,camOffset=0,timeElapse=(new Date).getTime(),totalElapse=0,zOffset=0,xSpeed=0,leftArrow=rightArrow=!1,mCubes=[],starSpeed=[],stars=[],scene=new THREE.Scene;var e=new THREE.AmbientLight(16777215);scene.add(e),(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setClearColor(16777215,0),renderer.setSize(width,height),document.body.appendChild(renderer.domElement),(camera=new THREE.PerspectiveCamera(15,width/height,.1,1e3)).position.x=0,camera.position.y=.25,camera.position.z=2;var t=new THREE.PlaneBufferGeometry(300,75,20);(plane=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:13158600}))).rotation.x+=-.5*Math.PI,plane.position.y=-.001,scene.add(plane);for(var a=0;a<numCubes;a++)mCubes[a]=new Cube(scene);var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(0,0,-.15),new THREE.Vector3(-.017,0,.04),new THREE.Vector3(.017,0,.04),new THREE.Vector3(0,.013,.02)),s.faces.push(new THREE.Face3(3,0,1)),s.faces.push(new THREE.Face3(1,2,3)),s.faces.push(new THREE.Face3(2,0,3)),(triangle=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:6579300}))).position.y=-2,scene.add(triangle);var o=new THREE.EdgesGeometry(s),r=new THREE.LineSegments(o,new THREE.MeshBasicMaterial({color:0}));scene.add(r),initStars(),uiScore.style.visibility="hidden",document.getElementById("highScore").innerHTML=(Math.floor(getCookie()/100)/10).toString(),setPreGame()}function initStars(){stars=[];for(var e=(new THREE.TextureLoader).load("assets/images/star.png"),t=new THREE.MeshBasicMaterial({map:e}),a=new THREE.BoxBufferGeometry(.5,.5,.1),s=0;s<10;s++)starSpeed[s]=[],stars[s]=new THREE.Mesh(a,t),stars[s].position.z=5,stars[s].position.x=20*Math.random()-10,stars[s].position.y=10*Math.random(),stars[s].rotation.z=2*Math.random()*Math.PI,starSpeed[s][0]=.003*Math.random()-.0015,starSpeed[s][1]=.003*Math.random()-.0015,scene.add(stars[s])}function gameReset(){for(var e of(uiNewGame.style.visibility="hidden",uiInfo.style.visibility="hidden",uiScore.style.color="#808080",uiScore.style.visibility="visible",document.body.style.backgroundColor="#A3A3A3",uiSettings.classList.remove("settingsVis"),document.querySelector("canvas").style.filter="blur(0px)",score=0,timeElapse=(new Date).getTime(),zOffset=0,xSpeed=0,triangle.position.y=0,mCubes))e.reset(stnBlock,!0,stnDiff);for(var t of stars)t.position.z=5;var a=Math.PI-this.camera.rotation.z%(2*Math.PI);rotStart=(Math.PI-Math.abs(a))*Math.sign(a),totalElapse=0,phase=1}function setPreGame(){for(var e of(uiScore.style.color="black",document.body.style.backgroundColor="#A3A3A3",uiNewGame.style.visibility="visible",uiInfo.style.visibility="visible",uiSettings.classList.add("settingsVis"),document.querySelector("canvas").style.filter="blur(5px)",mCubes))e.updateDesign(0);for(var t of(level=0,plane.material.color.setHex(13158600),stars))t.position.z=5}function newLevel(){for(var e of(levelBreak=(new Date).getTime(),level++,mCubes))e.updateDesign(level%5);switch(level%5){case 0:plane.material.color.setHex(13158600),document.body.style.backgroundColor="#FFFFFF";break;case 1:for(var t of(plane.material.color.setHex(0),document.body.style.backgroundColor="#000000",stars))t.position.z=-50;break;case 2:for(var t of(plane.material.color.setHex(9868950),document.body.style.backgroundColor="#969696",stars))t.position.z=5;break;case 3:plane.material.color.setHex(16777215),document.body.style.backgroundColor="#FFFFFF";break;case 4:plane.material.color.setHex(9868950),document.body.style.backgroundColor="#969696"}}function animate(){requestAnimationFrame(animate);var e=(new Date).getTime(),t=e-timeElapse;timeElapse=e;var a=t/100;switch(phase){case-1:xSpeed*=.99,camOffset*=.99,camera.rotation.z+=5e-4,updateCubes(.2*a);break;case 0:break;case 1:rightArrow||leftArrow?(leftArrow&&(xSpeed+=.02*a),rightArrow&&(xSpeed-=.02*a)):xSpeed*=.6*a,xSpeed=Math.max(-.02,Math.min(.02,xSpeed)),score=(zOffset+=.1*t/15)*(10+5*level),totalElapse+=t,uiScore.innerHTML=(Math.round(totalElapse/100)/10).toString(),camOffset+=.1*xSpeed,rightArrow||leftArrow||(camOffset/=1.3),camOffset=Math.min(.02,Math.max(-.02,camOffset)),rotStart*=.98,camera.rotation.z=camOffset/.03*.05*Math.PI+rotStart,3e4*(level+1)<totalElapse&&newLevel(),-1!=levelBreak&&e-levelBreak>5e3&&(levelBreak=-1),updateCubes(t/70)}updateStars(),1==phase?(renderer.setClearColor(16777215,0),renderer.render(scene,camera)):(renderer.setClearColor(10724259,1),renderer.render(scene,camera))}function updateStars(){for(var e=0;e<stars.length;e++)(stars[e].position.x<-10||stars[e].position.x>10||stars[e].position.y<0||stars[e].position.y>10)&&(stars[e].position.x=20*Math.random()-10,stars[e].position.y=10*Math.random()),stars[e].position.x+=starSpeed[e][0],stars[e].position.y+=starSpeed[e][1],stars[e].rotation.z+=.003}function updateCubes(e){for(var t of mCubes){var a=t.update(e,levelBreak,level,stnBounce,stnBlock,stnDiff);if(1==phase&&a){logHighscore(),phase=-1,setPreGame();break}}}function setCam(){switch(stnCam){case 0:camera.position.x=0,camera.position.y=.25,camera.position.z=2;break;case 1:camera.position.x=0,camera.position.y=.05,camera.position.z=.4;break;case 2:camera.position.x=0,camera.position.y=.02,camera.position.z=0}}function pauseGameScreen(){0==phase?(phase=1,uiPause.style.visibility="hidden",uiPause.style.opacity=0):1==phase&&(phase=0,uiPause.style.visibility="visible",uiPause.style.opacity=1)}function returnToMenu(){uiPause.style.opacity=0,uiPause.style.visibility="hidden",logHighscore(),rotOffset=(new Date).getTime()%5e4,phase=-1,setPreGame()}function updateDiff(e){stnDiff=e;for(var t=document.getElementById("difficulty").getElementsByClassName("select"),a=0;a<3;a++)t[a].classList.remove("focus");t[e].classList.add("focus")}function updateBounce(e){stnBounce=e;for(var t=document.getElementById("bounce").getElementsByClassName("select"),a=0;a<3;a++)t[a].classList.remove("focus");t[e].classList.add("focus")}function updateCam(e){stnCam=e;for(var t=document.getElementById("camera").getElementsByClassName("select"),a=0;a<3;a++)t[a].classList.remove("focus");t[e].classList.add("focus"),setCam()}function updateBlock(e){stnBlock=e;for(var t=document.getElementById("block").getElementsByClassName("select"),a=0;a<3;a++)t[a].classList.remove("focus");for(var s of(t[e].classList.add("focus"),mCubes))s.reset(stnBlock,!1,stnDiff);document.getElementById("bounce").style.opacity=e>0?"1.0":"0.0"}function logHighscore(){totalElapse>parseInt(getCookie())||""==getCookie()?(setCookie(totalElapse),uiHScore.innerHTML=(Math.floor(totalElapse/100)/10).toString()):uiHScore.innerHTML=(Math.floor(getCookie()/100)/10).toString()}function setCookie(e){document.cookie="highscore="+e.toString()+"; "}function getCookie(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){for(var a=e[t];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf("highscore="))return a.substring("highscore=".length,a.length)}return""}init(),animate(),document.addEventListener("resize",e=>{width=window.innerWidth,height=window.innerHeight,renderer.setSize(width,height),camera=new THREE.PerspectiveCamera(15,width/height,.1,1e3),setCam()}),document.addEventListener("keydown",e=>{if(null==e.keyCode)e.pageX>.5*width?rightArrow=!0:leftArrow=!0;else{var t=e.keyCode?e.keyCode:e.which;37==t?leftArrow=!0:39==t?rightArrow=!0:80==t&&pauseGameScreen()}}),document.addEventListener("keyup",e=>{if(null==e.keyCode)rightArrow=!1,leftArrow=!1;else{var t=e.keyCode?e.keyCode:e.which;37==t?leftArrow=!1:39==t&&(rightArrow=!1)}});
